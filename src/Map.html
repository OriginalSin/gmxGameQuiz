<div id="map"></div>

<style>

</style>

<script>
	const serverBase = window.serverBase || '//maps.kosmosnimki.ru/';

	export default {
		data() {
			return {
				layerGame: null,
				quizList: null,
				questions: null,
				permalink: null,
				map: null
			}
		},
		methods: {
			styleHook(it) {
				let {question} = this.get();
				return question && this.polyline && it.id === question.id ? {} : null;
			},
			getSections(arr, layerGame) {
				let attrIndexes = layerGame.getTileAttributeIndexes(),
					props = layerGame.getGmxProperties(),
					meta = props.MetaProperties,
					count = meta.count ? Number(meta.count.Value) : 10,
					sections = null;
				if (attrIndexes.section) {
					sections = {};
					arr.forEach(function(it) {
						let propsArr = it.properties,
							key = propsArr[attrIndexes.section];
						sections[key] = true;
					});
				}
				this.allData = arr;
				// this.set({questions: arr.sort(Math.random).slice(0, count)});
				this.set({sectionsList: sections});
			},
			reBuildQuestions(sectionsList) {
				let {layerGame} = this.get(),
					props = layerGame.getGmxProperties(),
					meta = props.MetaProperties,
					count = meta.count ? Number(meta.count.Value) : 10,
					attrIndexes = layerGame.getTileAttributeIndexes(),
					arr = [];
				this.allData.forEach(function(it) {
					let propsArr = it.properties,
						key = propsArr[attrIndexes.section];
					if (sectionsList[key]) {
						arr.push(it);
					}
				});
				arr = arr.sort(Math.random).slice(0, count);
				this.set({questions: arr});
// console.log('reBuildQuestions', this.allData.length, sectionsList, arr);
			},
			setLayerGame(layerID) {
				let layerGame = this.gmxMap.layersByID[layerID] ||
					this.gmxMap.layers[Math.floor(this.gmxMap.layers.length * Math.random())];

				if (layerGame) {
					let dm = layerGame.getDataManager(),
						props = layerGame.getGmxProperties(),
						// meta = props.MetaProperties,
						// count = meta.count ? Number(meta.count.Value) : 10,
						layerID = props.name;
					let ob = dm.addObserver({
						type: 'resend',
						layerID: layerID,
						callback: function (data) {
							if (data.count) {
								this.getSections(data.added, layerGame);
								ob.deactivate();
							}
							 // console.log('data', data);
						}.bind(this)
					});
					layerGame.setStyleHook(this.styleHook.bind(this));
					this.map.addLayer(layerGame);
					let st = localStorage.getItem('_gameQuiz_');
					let score = st ? JSON.parse(st) : {};
					this.set({layerGame: layerGame, score: score});
				}
			},
			showQuestionResult(ev) {
				if (this.polyline) { this.map.removeLayer(this.polyline); }
				let {question} = this.get(),
					bounds = question.dataOption.bounds.toLatLngBounds(true),
					center = bounds.getCenter(),
					isContains = bounds.contains(this._latlng),
					polyline = L.polyline([center, this._latlng], {color: 'red'}).addTo(this.map);
				this.map.fitBounds(polyline.getBounds());
				let geoJson = polyline.toGeoJSON().geometry;

				this.polyline = polyline;
				this.setPopupContent(geoJson, isContains);
				// console.log('showQuestionResult', this._latlng, question);
			},
			nextQuestion() {
				this.map.closePopup();
				this.map.removeLayer(this.polyline);
				this.polyline = null;
				this.root.nextQuestion(this.sc);
			},
			setPopupContent(geoJson, isContains) {
				let {question} = this.get();
				let node = L.DomUtil.create('div', ''),
					txt = L.DomUtil.create('div', '', node),
					button = L.DomUtil.create('button', '', node);
				if (geoJson) {
					let len = L.gmxUtil.geoJSONGetLength(geoJson),
						strLen = L.gmxUtil.getGeoJSONSummary(geoJson),
						resultQuestion = {},
						sc = 0;
					if (isContains) {
						sc = 10;
						txt.innerHTML = 'Отлично вам начислено: <b>' + sc + '</b> баллов';
						resultQuestion.ok = sc + ' баллов';
					} else {
						txt.innerHTML = 'Растояние от центра объекта:<br><b>' + strLen + '</b>';
					}
					resultQuestion.question = question;
					resultQuestion.len = len;
					resultQuestion.strLen = strLen;
					this.set({resultQuestion: resultQuestion});
					
					this.sc = sc;
					button.innerHTML = 'Следующий вопрос';
					L.DomEvent.on(button, 'click', this.nextQuestion, this);
				} else {
					txt.innerHTML = 'Я считаю что это здесь!';
					button.innerHTML = 'Показать';
					L.DomEvent.on(button, 'click', this.showQuestionResult, this);
				}

				this.popup.setContent(node);
				this.popupContent = node;
			},
			clickMap(ev) {
				this.map.closePopup();
				this._latlng = ev.latlng;
				this.popup = L.popup()
					.setLatLng(this._latlng);

				this.setPopupContent();
				this.map.openPopup(this.popup);
			},
			setQuizList() {
			},
			createMap(it) {
				let state = it.state || {},
					mapID = it.mapID || 'A557835E1B2344479C092FBB0158B529',
					layerID = it.layerID || '', //'5F2A707A119A45EF9BD490187E909830',
					apiKey = it.apiKey,
					pos = state.map ? state.map.position : {};

				var osm = it.base == 1 ? 
					L.tileLayer('//tilessputnik.ru/{z}/{x}/{y}.png', {
                        attribution: '<a href="http://maps.sputnik.ru">Спутник</a> © Ростелеком | © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
						maxNativeZoom: 18,
						maxZoom: 21
					}) :
					L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1Ijoia29zbW9zbmlta2kiLCJhIjoiY2lvbW1tNXN0MDAwdnc4bHg5ZWw2YXJtYSJ9.ON9Ovi3fuHc5RAipmLb2EQ', {
						attribution: '&copy; <a href="//mapbox.com/">mapbox</a>',
						maxNativeZoom: 18,
						maxZoom: 21
					});

				let map = new L.Map('map', {
					attribution: '&copy; <a href="//scanex.ru/">scanex</a>',
					allWorld: true,
					generalized: false,
					layers: [osm],
					center: new L.LatLng(pos.y || 26, pos.x || 83),
					zoom: pos.z || 7
				}).on('click', this.clickMap.bind(this), this);

				// map.gmxControlsManager.init();
				
				let arr = [];
				L.gmx.loadMap(mapID, {leafletMap: map}).then(function(gmxMap) {
					gmxMap.layers.forEach(function(it) {
						map.removeLayer(it);
						let props = it.getGmxProperties(),
							meta = props.MetaProperties,
							metaHash = {};
						for(let key in meta) {
							let val = meta[key].Value;
							metaHash[key] = val > 0 ? Number(val) : val;
						}
						arr.push({
							gmxLayer: it,
							metaHash: metaHash,
							title: props.title,
							layerID: props.name
						});
						it._gameZoom = metaHash.zoom || 3;
					});
					this.quizList = arr;
					this.gmxMap = gmxMap;
					if (layerID) {
						this.setLayerGame(layerID);
					} else {
						this.set({quizList: this.quizList});
					}
					// console.log('gmxMap', gmxMap);
				}.bind(this));
				this.map = map;
			}
		},
		oncreate() {
			let {urlParams} = this.get();
			this.createMap(urlParams);
		},

		onstate({ changed, current, previous }) {
			// console.log('in onstate', this);
			if (changed.selectQuiz && current.selectQuiz) {
				this.map.closePopup();
				if (this.polyline) { this.map.removeLayer(this.polyline); this.polyline = null; }
				this.set({quizList: this.quizList});
			} else if (changed.layerID && current.layerID) {
				this.setLayerGame(current.layerID);
			} else if (changed.question && current.question) {
				let {layerGame} = this.get();
				this.map.closePopup();
				if (this.polyline) { this.map.removeLayer(this.polyline); this.polyline = null; }
				this.map.setZoom(layerGame._gameZoom);
			} else if (changed.sectionsList && current.sectionsList) {
				this.reBuildQuestions(current.sectionsList);
			}
		}
	}
</script>
